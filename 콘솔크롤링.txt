(async () => {
  const CONFIG = {
    WORKER_IID: "247$4576",
    ROOT_MANAGER_IID: "247$4528",

    NAVIGABLE: {
      initialStep: "2998$14648",
      instanceSetId: "1$715",
      instanceDid: ""
    },

    PROFILE_VIEW_IID: "15$5312",

    DELAY_MS_NAV: 120,
    DELAY_MS_PROFILE: 120,
    MAX_PEOPLE: 10000
  };

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  /***********************
   * ê³µí†µ ìœ í‹¸
   ***********************/
  function normalize(s) {
    return (s ?? "")
      .toString()
      .toLowerCase()
      .replace(/[^\p{L}\p{N}]+/gu, " ") // ë¬¸ì/ìˆ«ìë§Œ ë‚¨ê¹€
      .replace(/\s+/g, " ")
      .trim();
  }

  function downloadTextFile(filename, text, mime = "text/plain;charset=utf-8", withBom = false) {
    const payload = withBom ? ("\uFEFF" + text) : text;
    const blob = new Blob([payload], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function fetchJson(url, opt) {
    const res = await fetch(url, opt);
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);

    if (text.trim().startsWith("<")) {
      console.warn("[NOT JSON]", {
        url,
        status: res.status,
        head: text.slice(0, 200)
      });
      throw new Error("Workday returned non-JSON");
    }
    return JSON.parse(text);
  }

  /***********************
   * Workday API
   ***********************/
  async function fetchNavigablePost(managerIid) {
    const url = `https://wd3.myworkday.com/advantech/navigable/${managerIid}.htmld`;
    const body = new URLSearchParams({
      "initial-step": CONFIG.NAVIGABLE.initialStep,
      "navigable-instance-iid": managerIid,
      "navigable-instance-set-id": CONFIG.NAVIGABLE.instanceSetId,
      "navigable-instance-did": CONFIG.NAVIGABLE.instanceDid || "",
      "navigable-worker-iid": CONFIG.WORKER_IID,
      "effective": ""
    }).toString();

    return fetchJson(url, {
      method: "POST",
      credentials: "include",
      headers: {
        "accept": "application/json, text/plain, */*",
        "content-type": "application/x-www-form-urlencoded",
        "x-requested-with": "XMLHttpRequest"
      },
      body
    });
  }

  async function fetchWorkerProfile(workerIid) {
    const url = `https://wd3.myworkday.com/advantech/inst/${CONFIG.PROFILE_VIEW_IID}/${workerIid}.htmld`;
    return fetchJson(url, {
      method: "GET",
      credentials: "include",
      headers: {
        "accept": "*/*",
        "x-requested-with": "XMLHttpRequest"
      }
    });
  }

  /***********************
   * íŒŒì‹±
   ***********************/
  function extractChildIidsFromNavigable(resp) {
    const out = [];
    const containers = resp?.body?.navigatorContainers || [];

    for (const c of containers) {
      if (c?.navigatorContainerNodeType !== "CHILD_NODES_AND_LEAVES") continue;
      for (const d of (c?.navigatorDetails || [])) {
        for (const it of (d?.navigatorItems || [])) {
          const iid = it?.owner?.instances?.[0]?.instanceId;
          if (iid) out.push(iid);
        }
      }
    }
    return [...new Set(out)];
  }

  function pickPhone(workPhoneNodes) {
    const arr = Array.isArray(workPhoneNodes) ? workPhoneNodes : [];
    const phones = arr.map(x => (x?.phoneNumber ?? "").trim()).filter(Boolean);

    return (
      phones.find(p => /^582\b/.test(p)) ||
      phones.find(p => /^\+82\b/.test(p)) ||
      phones[0] ||
      ""
    );
  }

  function extractRowFromProfile(resp, workerIid) {
    const contactInfo = resp?.body?.compositeViewHeader?.contactInfo || {};

    const name =
      resp?.title?.instances?.[0]?.text ||
      ((contactInfo.firstName && contactInfo.lastName)
        ? `${contactInfo.firstName} ${contactInfo.lastName}`.trim()
        : "");

    const organization = contactInfo.organization || "";
    const title =
      contactInfo.businessTitle ||
      resp?.body?.compositeViewHeader?.subtitle?.label?.value ||
      "";

    const phone = pickPhone(contactInfo.workPhoneNodes);

    // ğŸ”‘ ì¡°ì§ í‚¤(ê·¸ë£¹í•‘/ì •ë ¬ìš©)
    const organizationKey = normalize(organization) || "(no_organization)";
    const organizationDisplay = organization || "(No Organization)";

    // ğŸ”‘ ê²€ìƒ‰ìš© ì •ê·œí™” í•„ë“œ
    const searchKey = normalize(
      [name, organizationDisplay, title, phone, workerIid].join(" ")
    );

    return {
      iid: workerIid,
      name,
      organization: organizationDisplay,     // ì›ë¬¸ í‘œì‹œìš©
      organizationKey,                      // ê·¸ë£¹í•‘/ì •ë ¬ìš©
      title,
      phone,
      searchKey
    };
  }

  /***********************
   * ê·¸ë£¹í•‘ (organizationKey ê¸°ì¤€)
   ***********************/
  function groupByOrganization(rows) {
    const map = new Map();

    for (const r of rows) {
      const key = r.organizationKey || "(no_organization)";
      if (!map.has(key)) {
        map.set(key, {
          orgKey: key,
          orgName: r.organization || "(No Organization)",
          count: 0,
          employees: []
        });
      }
      const g = map.get(key);
      g.employees.push(r);
      g.count++;
    }

    // ì¡°ì§ëª…/ì´ë¦„ ê¸°ì¤€ ì •ë ¬(ë³´ê¸° ì¢‹ê²Œ)
    const groups = Array.from(map.values());
    groups.sort((a, b) => (a.orgName || "").localeCompare(b.orgName || ""));

    for (const g of groups) {
      g.employees.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    }

    return groups;
  }

  /***********************
   * STEP A: IID ìˆ˜ì§‘
   ***********************/
  console.log("ğŸš€ STEP A: Collecting IIDs...");
  const visited = new Set();
  const queue = [CONFIG.ROOT_MANAGER_IID];
  const allIids = [];

  while (queue.length && allIids.length < CONFIG.MAX_PEOPLE) {
    const cur = queue.shift();
    if (!cur || visited.has(cur)) continue;
    visited.add(cur);

    let nav;
    try {
      nav = await fetchNavigablePost(cur);
    } catch (e) {
      console.warn("[NAV FAIL]", cur, e);
      continue;
    }

    allIids.push(cur);

    const kids = extractChildIidsFromNavigable(nav).filter(x => !visited.has(x));
    queue.push(...kids);

    if (allIids.length % 50 === 0) console.log(`[STEP A] collected=${allIids.length} queue=${queue.length}`);
    await sleep(CONFIG.DELAY_MS_NAV);
  }

  console.log(`âœ… STEP A DONE: total=${allIids.length}`);

  /***********************
   * STEP B: í”„ë¡œí•„
   ***********************/
  console.log("ğŸš€ STEP B: Fetching profiles...");
  const rows = [];
  let ok = 0, fail = 0;

  for (let i = 0; i < allIids.length; i++) {
    const iid = allIids[i];
    try {
      const prof = await fetchWorkerProfile(iid);
      rows.push(extractRowFromProfile(prof, iid));
      ok++;
    } catch (e) {
      fail++;
      console.warn("[PROFILE FAIL]", iid, e);
      rows.push({
        iid,
        name: "",
        organization: "(No Organization)",
        organizationKey: "(no_organization)",
        title: "",
        phone: "",
        searchKey: normalize(iid)
      });
    }

    if ((i + 1) % 50 === 0) console.log(`[STEP B] ${i + 1}/${allIids.length} ok=${ok} fail=${fail}`);
    await sleep(CONFIG.DELAY_MS_PROFILE);
  }

  console.log(`âœ… DONE ok=${ok} fail=${fail}`);

  /***********************
   * CSV ë‹¤ìš´ë¡œë“œ (email ì œì™¸)
   ***********************/
  const header = ["name", "organization", "title", "phone", "iid"];
  const esc = (s) => `"${(s ?? "").toString().replaceAll('"', '""')}"`;

  const csv = [
    header.join(","),
    ...rows.map(r => header.map(h => esc(r[h])).join(","))
  ].join("\n");

  downloadTextFile("workday_employees_min.csv", csv, "text/csv;charset=utf-8", true);

  /***********************
   * JSON ë‹¤ìš´ë¡œë“œ (flat)
   ***********************/
  downloadTextFile(
    "workday_employees_min.json",
    JSON.stringify(rows, null, 2),
    "application/json;charset=utf-8",
    false
  );

  /***********************
   * JSON ë‹¤ìš´ë¡œë“œ (organization ê·¸ë£¹í•‘)
   ***********************/
  const byOrg = groupByOrganization(rows);
  downloadTextFile(
    "workday_employees_by_org.json",
    JSON.stringify(byOrg, null, 2),
    "application/json;charset=utf-8",
    false
  );

  // ë””ë²„ê·¸ìš©
  window.__WD_EMPLOYEES_MIN__ = rows;
  window.__WD_EMPLOYEES_BY_ORG__ = byOrg;

  console.log("ğŸ“¦ CSV + JSON(flat) + JSON(by_org) ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
})();
